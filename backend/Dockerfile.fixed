FROM node:16

WORKDIR /app

COPY package.json ./

# Install SQLite dependencies
RUN apt-get update && apt-get install -y python3 build-essential sqlite3

# Install dependencies
RUN npm install

# Copy the rest of the application
COPY . .

# Create database directory
RUN mkdir -p /app/data

# Create a script to fix database issues
RUN echo '#!/bin/sh\nnode /app/scripts/fix-schema.js' > /app/fix-db.sh && chmod +x /app/fix-db.sh

# Modify database.js to use file-based SQLite
RUN sed -i 's/storage: "database.sqlite"/storage: "\/app\/data\/database.sqlite"/g' config/database.js || true

# Create fix-schema.js script
RUN mkdir -p /app/scripts && echo 'import sequelize from "../config/database.js";\n\nconst fixSchema = async () => {\n  try {\n    console.log("ðŸ”§ Attempting to fix database schema...");\n    await sequelize.sync({ force: true });\n    console.log("âœ… Database schema has been reset and recreated");\n  } catch (error) {\n    console.error("âŒ Failed to fix schema:", error);\n  } finally {\n    process.exit(0);\n  }\n};\n\nfixSchema();' > /app/scripts/fix-schema.js

# Apply schema fixes on startup
RUN echo '#!/bin/sh\nnode /app/scripts/fix-schema.js && npm run dev' > /app/start.sh && chmod +x /app/start.sh

EXPOSE 5001

CMD ["/app/start.sh"] 